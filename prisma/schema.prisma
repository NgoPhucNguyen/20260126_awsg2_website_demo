generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- QUẢN LÝ ĐỊA CHỈ & KHO ---

model Address {
  id            String   @id @default(uuid())
  fullAddress   String   @map("full_address")
  province      String
  district      String
  ward          String
  streetAddress String   @map("street_address")
  createdAt     DateTime @default(now()) @map("created_at")

  customers Customer[]
  employees Employee[]

  @@map("address")
}

model Warehouse {
  id            String @id @default(uuid())
  name          String
  fullAddress   String @map("full_address")
  province      String
  district      String
  ward          String
  streetAddress String @map("street_address")

  employees    Employee[]
  importations Importation[]
  inventories  Inventory[]
  shipments    Shipment[]

  @@map("warehouse")
}

// --- QUẢN LÝ NGƯỜI DÙNG & NHÂN VIÊN ---

model Customer {
  id           String    @id @default(uuid())
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  account_name String    @map("account_name")
  mail         String    @unique
  phoneNumber  String?   @map("phone_number") @db.VarChar(10)
  passwordHash String    @map("password_hash")
  // Stores the long-lived session token
  refreshToken String?   @map("refresh_token") 
  avatarUrl    String?   @map("avatar_url")
  isActive     Boolean   @default(true) @map("is_active")
  gender       String?   @db.VarChar(10)
  birthday     DateTime? @db.Date
  skinProfile  Json?     @map("skin_profile")
  tier         Int?
  createdAt    DateTime  @default(now()) @map("created_at")
  addressId    String?   @map("address_id")
  //user forgot password
  resetTokens  PasswordResetToken[] 
  

  address Address? @relation(fields: [addressId], references: [id])
  carts   Cart[]

  @@map("customer")
}

// 1. Add this new model
model PasswordResetToken {
  id         String   @id @default(uuid())
  tokenHash  String   @unique @map("token_hash")
  customerId String   @map("customer_id")
  expiresAt  DateTime @map("expires_at")

  // Link only to Customer for now
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("password_reset_token")
}

model Employee {
  id           String   @id @default(uuid())
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  mail         String   @unique
  phoneNumber  String   @map("phone_number") @db.VarChar(10)
  addressId    String   @map("address_id")
  warehouseId  String   @map("warehouse_id")
  isActive     Boolean  @default(true) @map("is_active")
  gender       String?  @db.VarChar(10)
  birthday     DateTime @db.Date
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  address   Address?   @relation(fields: [addressId], references: [id])
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id])

  @@map("employee")
}

// --- QUẢN LÝ SẢN PHẨM ---

model Brand {
  id       String    @id @default(uuid())
  name     String
  products Product[]

  @@map("brand")
}

model Category {
  id            Int     @id @default(autoincrement())
  name          String  @db.Char(255)
  nameVn        String  @map("name_vn")
  slug          String?
  parentId      Int?    @map("parent_id")
  categoryLevel Int     @map("category_level")

  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")
  products Product[]

  @@map("category")
}

model Product {
  id          Int     @id @default(autoincrement())
  name        String
  nameVn      String  @map("name_vn")
  brandId     String  @map("brand_id")
  categoryId  Int     @map("category_id")
  description String?
  ingredient  String
  skinType    String? @map("skin_type")
  isActive    Boolean @default(true) @map("is_active")

  brand    Brand?           @relation(fields: [brandId], references: [id])
  category Category?        @relation(fields: [categoryId], references: [id])
  variants ProductVariant[]

  @@map("product")
}

model ProductVariant {
  id            Int     @id @default(autoincrement())
  productId     Int     @map("product_id")
  sku           String
  specification Json
  unitPrice     Int     @map("unit_price")
  thumbnailUrl  String  @map("thumbnail_url")
  slug          String?

  product      Product?            @relation(fields: [productId], references: [id])
  promotions   ProductPromotion[]
  images       ProductImage[]
  impDetails   ImportationDetail[]
  inventories  Inventory[]
  orderDetails OrderDetail[]
  shipDetails  ShipmentDetail[]

  @@map("product_variant")
}

model ProductImage {
  id               Int    @id @default(autoincrement())
  productVariantId Int    @map("product_variant_id")
  imageUrl         String @map("image_url")
  displayOrder     Int    @map("display_order")
  altText          String @map("alt_text")

  variant ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@map("product_images")
}

// --- QUẢN LÝ KHUYẾN MÃI ---

model Coupon {
  id          String     @id @default(uuid())
  description String?
  code        String     @unique
  type        CouponType
  value       Float
  rule        Json
  createdAt   DateTime   @default(now()) @map("create_at")
  expireAt    DateTime   @map("expire_at")
  usageLimit  Int        @map("usage_limit")

  shippingCarts Cart[] @relation("ShippingCoupon")
  couponCarts   Cart[] @relation("MainCoupon")

  @@map("coupon")
}

enum CouponType {
  PERCENTAGE // Giảm theo %
  FIXED // Giảm một số tiền cụ thể (ví dụ: trừ 50k)
}

model Promotion {
  id          String        @id @default(uuid())
  description String?
  type        PromotionType
  value       Float
  rule        Json
  startTime   DateTime      @map("start_time")
  endTime     DateTime      @map("end_time")

  products ProductPromotion[]

  @@map("promotion")
}

enum PromotionType {
  PERCENTAGE // Giảm theo %
  FIXED // Giảm một số tiền cụ thể (ví dụ: trừ 50k)
}

model ProductPromotion {
  id               String @id @default(uuid())
  promotionId      String @map("promotion_id")
  productVariantId Int    @map("product_variant_id")

  promotion Promotion?      @relation(fields: [promotionId], references: [id])
  variant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@map("product_promotion")
}

// --- QUẢN LÝ NHẬP KHO & TỒN KHO ---

model Supplier {
  id           String        @id @default(uuid())
  name         String
  importations Importation[]

  @@map("supplier")
}

model Importation {
  id           String   @id @default(uuid())
  supplierId   String   @map("supplier_id")
  warehouseId  String   @map("warehouse_id")
  orderTime    DateTime @map("order_time")
  importTime   DateTime @map("import_time")
  totalExpense Int      @map("total_expense")

  supplier  Supplier?           @relation(fields: [supplierId], references: [id])
  warehouse Warehouse?          @relation(fields: [warehouseId], references: [id])
  details   ImportationDetail[]

  @@map("importation")
}

model ImportationDetail {
  id               String @id @default(uuid())
  importationId    String @map("importation_id")
  productVariantId Int    @map("product_variant_id")
  quantity         Int
  unitPrice        Int    @map("unit_price")

  importation Importation?    @relation(fields: [importationId], references: [id])
  variant     ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@map("importation_detail")
}

model Inventory {
  id               String @id @default(uuid())
  productVariantId Int    @map("product_variant_id")
  warehouseId      String @map("warehouse_id")
  quantity         Int

  variant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  warehouse Warehouse?      @relation(fields: [warehouseId], references: [id])

  @@map("inventory")
}

// --- QUẢN LÝ ĐƠN HÀNG & VẬN CHUYỂN ---

model Cart {
  id               String   @id @default(uuid())
  customerId       String   @map("customer_id")
  status           String
  createdAt        DateTime @default(now()) @map("create_at")
  shippingCouponId String?  @map("shipping_coupon_id")
  shippingDiscount Int      @default(0) @map("shipping_discount")
  couponId         String?  @map("coupon_id")
  couponDiscount   Int      @map("coupon_discount")
  finalPrice       Int      @map("final_price")

  customer       Customer?     @relation(fields: [customerId], references: [id])
  shippingCoupon Coupon?       @relation("ShippingCoupon", fields: [shippingCouponId], references: [id])
  mainCoupon     Coupon?       @relation("MainCoupon", fields: [couponId], references: [id])
  orderDetails   OrderDetail[]
  shipments      Shipment[]

  @@map("cart")
}

model OrderDetail {
  id               String @id @default(uuid())
  orderId          String @map("order_id")
  productVariantId Int    @map("product_variant_id")
  quantity         Int
  originalPrice    Int    @map("original_price")
  unitPrice        Int    @map("unit_price")

  cart        Cart?            @relation(fields: [orderId], references: [id])
  variant     ProductVariant?  @relation(fields: [productVariantId], references: [id])
  shipDetails ShipmentDetail[]

  @@map("order_detail")
}

model Shipment {
  id              String @id @default(uuid())
  status          String
  orderId         String @map("order_id")
  warehouseId     String @map("warehouse_id")
  trackingCode    String @map("tracking_code")
  shippingCarrier String @map("shipping_carrier")
  shippingFee     Int    @map("shipping_fee")

  cart      Cart?            @relation(fields: [orderId], references: [id])
  warehouse Warehouse?       @relation(fields: [warehouseId], references: [id])
  details   ShipmentDetail[]

  @@map("shipment")
}

model ShipmentDetail {
  id               String @id @default(uuid())
  status           String
  shipmentId       String @map("shipment_id")
  orderItemId      String @map("order_item_id")
  productVariantId Int    @map("product_variant_id")
  quantity         Int
  shippingFee      Int    @map("shipping_fee")

  shipment    Shipment?       @relation(fields: [shipmentId], references: [id])
  orderDetail OrderDetail?    @relation(fields: [orderItemId], references: [id])
  variant     ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@map("shipment_detail")
}
